$ ->
  questions = JSON.parse '<%= JSON.dump(JSON.load(Rails.root + "config/survey.json")) %>'
  optionTemplate = '<label class="pm-survey-label"><input type="radio" name="{{identifier}}" value="{{value}}">{{description}}</label>'
  questionNumber = 0
  results = []

  submitStep = ->
    if questions[questionNumber].type == "info"
      questionNumber += 1
      nextStep()
    else if $('#pm-survey input[type=radio]:checked').length == 1
      results[questionNumber] = extractAnswer()
      questionNumber += 1
      nextStep()
    else
      showError('please select')

  clearMarkup = ->
    $('#pm-survey-error').text('')
    $('#pm-survey-text').text('')
    $('#pm-survey-options').text('')

  extractAnswer = ->
    answer = $('#pm-survey input[type=radio]:checked')
    id: answer[0].name
    value: answer[0].value

  generateOptionMarkup = (options, identifier) ->
    markup = ""
    options.forEach (option, index) ->
      markup += Mustache.render optionTemplate,
        value: index
        description: option
        identifier: identifier

    markup

  generateBig5Markup = (identifier) ->
    generateOptionMarkup ["trifft gar nicht zu", "trifft eher nicht zu", "trifft eher zu", "trifft genau zu"], identifier

  submitSurveyToServer = ->
    console.log 'submitting...'
    console.log results

  showSuccess = ->
    $('#pm-survey').text('thank you')

  showError = ->
    $('#pm-survey-error').text('please answer')

  nextStep = ->
    clearMarkup()
    question = questions[questionNumber]
    if question
      question_text = question.text

      if question.type == "big5"
        $('#pm-survey-options').html generateBig5Markup(question.id)
      else if question.type == 'statistic'
        $('#pm-survey-options').html generateOptionMarkup(question.options, question.id)
        question_text = "FÃ¼r statistische Zwecke: " + question_text

      $('#pm-survey-text').text(question_text)
    else # survey done
      submitSurveyToServer()
      showSuccess()

  $('#pm-survey').on 'submit', (e) ->
    submitStep()
    e.preventDefault()

  # # #
  # init
  nextStep(questionNumber)