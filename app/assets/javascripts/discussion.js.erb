var is_question = false;
var discussion_id;
  $(document).bind('popstate', function() {
    alert("A");
    });

function init_discussion(){
  //Handling the two submit buttons and clearing the form
  // Pusher subscribtions
  discussion_id = $('#discussion').attr('data-discussionId');
  $('body').attr("data-no-turbolink", "true");
  scroll_down($('#moderator_chat'));
  scroll_down($('#discussion_chat'));
  register_events();
  bind_new_argument();
  bind_vote($('#discussion').attr('data-isModerator'));
  bind_new_question();
  bind_user_leaved();
  bind_user_entered();
  enter_discussion()

}


function bind_new_argument(){
    PrivatePub.subscribe("/discussion/"+discussion_id+"/arguments/new", function(data){
        $.ajax({
          type: 'GET',
          url: '/arguments/'+data.id
        });
    })
}

function submit_argument(){
  $("#new_argument_button").submit();
  $('#argument_content').val('');
}

function bind_vote(is_moderator){
  if(is_moderator){
      PrivatePub.subscribe("/discussion/"+discussion_id+"/votes/new", function(data){
      if(data.is_like){
        $("#like_badge_"+data.id).text((parseInt($("#like_badge_"+data.id).text())+1));
      }
      else{
        $("#dislike_badge_"+data.id).text((parseInt($("#dislike_badge_"+data.id).text())+1));
      }
    });
  }
}

function bind_new_question(){
    PrivatePub.subscribe("/discussion/"+discussion_id+"/questions/new", function(data){
    $("#question").text("Frage: "+data.topic);
  });
}
function register_vote_buttons(){
  $(".vote_button").click(function( event ){
    $.each($($(this).attr('data-argument')), function(){}).addClass("disabled");
  });
}

function register_events(){
  register_vote_buttons();

  $("#new_question_button").click(function( event ){
    is_question = true;
    $.ajax({
      type: 'POST',
      url: '/questions/',
      data: { question: { topic: $('#argument_content').val() , 
                          discussion_id:  discussion_id } }
    });
    $('#argument_content').val('');
  });
  
  $("#new_argument").submit(function( event ){
    if (is_question){
      is_question = false;
      return false;
    }
    is_question = false;
    return true;
  });
  
  $("#new_argument_button").click(function( event ){
    submit_argument();
  });

  $('#argument_content').keydown(function( event ){
    if(event.keyCode == 13){
      submit_argument();
      return false;
    }
  });
  window.onbeforeunload = function() { leave_discussion(); };

}

function leave_discussion(){
  $.ajax({
    type: 'POST',
    url: '/discussions/'+$('#discussion').attr('data-discussionId')+'/leave',
    async: false
  });
}

function enter_discussion(){
  $.ajax({
    type: 'POST',
    url: '/discussions/'+$('#discussion').attr('data-discussionId')+'/enter'
  });
}



function bind_user_leaved(){
    PrivatePub.subscribe("/discussion/"+discussion_id+"/users/leaved", function(data){
    $.ajax({
      type: 'GET',
      url: '/user_leaved/'+data.user_id
    });
  });
}

function bind_user_entered(){
    PrivatePub.subscribe("/discussion/"+discussion_id+"/users/entered", function(data){
    $.ajax({
      type: 'GET',
      url: '/user_entered/'+data.user_id
    });
  });
}

function scroll_down(div){
  div.stop().animate({
      scrollTop: div[0].scrollHeight},
      800);
}